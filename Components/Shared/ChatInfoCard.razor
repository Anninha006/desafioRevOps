@using System.Text.Json
@using REVOPS.DevChallenge.Context.Entities

<div class="chat-info-v2 fade-in">
    <!-- CabeÃ§alho com Foto de Perfil -->
    <div class="contact-header-card text-center mb-4">
        <div class="avatar-wrapper mx-auto mb-3">
            @if (!string.IsNullOrEmpty(Record.ContactProfilePictureUrl))
            {
                <img src="@Record.ContactProfilePictureUrl" alt="@Record.ContactName" class="large-avatar shadow-glow" />
            }
            else
            {
                <div class="large-avatar-placeholder shadow-glow">
                    @GetInitials(Record.ContactName)
                </div>
            }
        </div>
        <h2 class="contact-name mb-1">@(Record.ContactName ?? "Contato Desconhecido")</h2>
        <div class="contact-subinfo d-flex justify-content-center gap-3 align-items-center">
            <span class="text-secondary"><i class="bi bi-telephone"></i> @(Record.ContactPhoneNumber ?? "Sem telefone")</span>
            @if (Record.IsAnyAttendantAssigned)
            {
                <span class="badge badge-open"><i class="bi bi-person-check"></i> Atendente: @(Record.AssignedMemberId ?? "AtribuÃ­do")</span>
            }
            else
            {
                <span class="badge badge-warning"><i class="bi bi-person-dash"></i> Sem Atendente</span>
            }
        </div>
    </div>

    <div class="row g-4">
        <!-- Card de Status -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header" style="background: linear-gradient(135deg, #005C55 0%, #007A70 100%); color: #FFFFFF;"><i class="bi bi-activity me-2"></i> Status do Chat</div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">Estado</span>
                        <span class="info-value">
                            @if (Record.IsOpen)
                            {
                                <span class="badge badge-open">Aberto</span>
                            }
                            else
                            {
                                <span class="badge badge-closed">Fechado</span>
                            }
                        </span>
                    </div>
                    @if (Record.IsWaiting)
                    {
                        <div class="info-row">
                            <span class="info-label">Aguardando</span>
                            <span class="info-value">
                                <span class="badge badge-waiting pulse">Sim</span>
                            </span>
                        </div>
                        @if (Record.WaitingSinceUTC.HasValue)
                        {
                            <div class="waiting-indicator mt-3">
                                <div class="waiting-time">@FormatWaitingTime(Record.WaitingSinceUTC.Value)</div>
                                <div class="text-secondary small">em espera</div>
                            </div>
                        }
                    }
                    <div class="info-row">
                        <span class="info-label">NÃ£o lidas</span>
                        <span class="info-value">
                            @if (Record.TotalUnread > 0)
                            {
                                <span class="badge bg-danger">@Record.TotalUnread</span>
                            }
                            else
                            {
                                <span class="text-muted">0</span>
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de ConexÃ£o -->
        <div class="col-md-6">
            <div class="card h-100 bg-white">
                <div class="card-header" style="background: linear-gradient(135deg, #005C55 0%, #007A70 100%); color: #FFFFFF;"><i class="bi bi-diagram-3 me-2"></i> Origem e Setor</div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label" style="color: #666 !important; -webkit-text-fill-color: initial !important;">Canal</span>
                        <span class="info-value" style="color: #000 !important; -webkit-text-fill-color: #000 !important; font-weight: 600;">@(Record.ChannelName ?? "-")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label" style="color: #666 !important; -webkit-text-fill-color: initial !important;">Setor</span>
                        <span class="info-value" style="color: #000 !important; -webkit-text-fill-color: #000 !important; font-weight: 600;">@(Record.SectorName ?? "-")</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Record.ActiveBotName))
                    {
                        <div class="info-row">
                            <span class="info-label" style="color: #666 !important; -webkit-text-fill-color: initial !important;">Bot Ativo</span>
                            <span class="info-value" style="color: #0d6efd !important; -webkit-text-fill-color: #0d6efd !important;">ðŸ¤– @Record.ActiveBotName</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label" style="color: #666 !important; -webkit-text-fill-color: initial !important;">ID do Chat</span>
                        <span class="info-value small font-monospace" style="color: #000 !important; -webkit-text-fill-color: #000 !important;">@Record.ChatId</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de Ãšltima Mensagem -->
        @if (!string.IsNullOrEmpty(Record.LastMessageContent))
        {
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between" style="background: linear-gradient(135deg, #005C55 0%, #007A70 100%); color: #FFFFFF;">
                        <span><i class="bi bi-chat-left-text me-2"></i> Ãšltima Mensagem</span>
                        <small style="color: rgba(255,255,255,0.7);">@Record.LastMessageAtUTC?.ToLocalTime().ToString("HH:mm")</small>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-3 align-items-start">
                            <span class="badge @(Record.LastMessageSource == "Contact" ? "badge-waiting" : "badge-open")">
                                @(Record.LastMessageSource == "Contact" ? "Cliente" : "Equipe")
                            </span>
                            <p class="mb-0 message-content">@Record.LastMessageContent</p>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Card de Etiquetas -->
        @if (!string.IsNullOrEmpty(Record.ChatTags) || !string.IsNullOrEmpty(Record.ContactTags))
        {
            <div class="col-12">
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #005C55 0%, #007A70 100%); color: #FFFFFF;"><i class="bi bi-tags me-2"></i> Etiquetas (Tags)</div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Record.ChatTags))
                        {
                            <div class="mb-3">
                                <small class="text-muted d-block mb-2">Chat:</small>
                                <div class="d-flex flex-wrap">
                                    @foreach (var tag in ParseTags(Record.ChatTags))
                                    {
                                        <span class="tag">@tag.Emoji @tag.Name</span>
                                    }
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Record.ContactTags))
                        {
                            <div>
                                <small class="text-muted d-block mb-2">Contato:</small>
                                <div class="d-flex flex-wrap">
                                    @foreach (var tag in ParseTags(Record.ContactTags))
                                    {
                                        <span class="tag" style="border-color: var(--pink); color: var(--pink);">@tag.Emoji @tag.Name</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .avatar-wrapper {
        width: 120px;
        height: 120px;
        position: relative;
    }
    .large-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--accent);
        object-fit: cover;
    }
    .large-avatar-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: var(--gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: 800;
        color: white;
        border: 4px solid var(--border);
    }
    .contact-name {
        font-size: 2.25rem;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .message-content {
        color: var(--text-primary);
        font-size: 1.1rem;
        line-height: 1.5;
    }
    .shadow-glow {
        box-shadow: 0 0 30px var(--accent-glow);
    }
</style>

@code {
    [Parameter]
    public required ChatInfoRecord Record { get; set; }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string FormatWaitingTime(DateTime waitingSince)
    {
        var duration = DateTime.UtcNow - waitingSince;
        if (duration.TotalDays >= 1)
            return $"{(int)duration.TotalDays}d {duration.Hours}h";
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}min";
        return $"{(int)duration.TotalMinutes} min";
    }

    private List<TagInfo> ParseTags(string? tagsJson)
    {
        if (string.IsNullOrEmpty(tagsJson)) return new();
        try
        {
            return JsonSerializer.Deserialize<List<TagInfo>>(tagsJson) ?? new();
        }
        catch
        {
            return new();
        }
    }

    private class TagInfo
    {
        public string? Name { get; set; }
        public string? Emoji { get; set; }
        public string? Color { get; set; }
    }
}
