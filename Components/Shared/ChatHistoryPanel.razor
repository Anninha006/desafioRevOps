@using REVOPS.DevChallenge.Context.Entities

<div class="card shadow-lg">
    <div class="card-header d-flex justify-content-between align-items-center bg-elevated">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Histórico de Consultas</h5>
        <span class="badge bg-secondary">@History.Count registros</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-dark mb-0 custom-history-table">
                <thead>
                    <tr>
                        <th class="ps-4">Contato</th>
                        <th>ID do Chat</th>
                        <th>Status</th>
                        <th>Espera</th>
                        <th>Pesquisado em</th>
                        <th class="pe-4 text-end">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    @if (History.Count == 0)
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="bi bi-folder-x d-block mb-2" style="font-size: 2rem;"></i>
                                Nenhuma pesquisa realizada ainda.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var record in History)
                        {
                            <tr class="align-middle">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="avatar-sm">
                                            @if (!string.IsNullOrEmpty(record.ContactProfilePictureUrl))
                                            {
                                                <img src="@record.ContactProfilePictureUrl" alt="@record.ContactName" class="rounded-circle border border-secondary" style="width: 32px; height: 32px;" />
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                    @GetInitials(record.ContactName)
                                                </div>
                                            }
                                        </div>
                                        <div class="fw-bold">@(record.ContactName ?? "Desconhecido")</div>
                                    </div>
                                </td>
                                <td>
                                    <small class="font-monospace text-secondary">@record.ChatId</small>
                                </td>
                                <td>
                                    @if (record.IsOpen)
                                    {
                                        <span class="badge badge-open">Aberto</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-closed">Fechado</span>
                                    }
                                </td>
                                <td>
                                    @if (record.IsWaiting && record.WaitingSinceUTC.HasValue)
                                    {
                                        <span class="text-warning small"><i class="bi bi-hourglass-split"></i> @FormatWaitingTime(record.WaitingSinceUTC.Value)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td class="text-muted small">
                                    @record.SearchedAtUTC.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                </td>
                                <td class="pe-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => OnSelect.InvokeAsync(record)">
                                        <i class="bi bi-eye"></i> Visualizar
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .custom-history-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    .custom-history-table thead th {
        background: var(--bg-elevated);
        border-bottom: 2px solid var(--border);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    .custom-history-table tbody tr {
        transition: background-color 0.2s ease;
        border-bottom: 1px solid var(--border);
    }
    .custom-history-table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.03) !important;
    }
    .avatar-sm {
        flex-shrink: 0;
    }
</style>

@code {
    [Parameter]
    public List<ChatInfoRecord> History { get; set; } = new();

    [Parameter]
    public EventCallback<ChatInfoRecord> OnSelect { get; set; }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string FormatWaitingTime(DateTime waitingSince)
    {
        var duration = DateTime.UtcNow - waitingSince;
        if (duration.TotalDays >= 1)
            return $"{(int)duration.TotalDays}d";
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h";
        return $"{(int)duration.TotalMinutes}m";
    }
}
