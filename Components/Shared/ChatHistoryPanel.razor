@using REVOPS.DevChallenge.Context.Entities

<div class="card history-card shadow-lg">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #005C55 0%, #007A70 100%); border-bottom: none;">
        <h5 class="mb-0" style="color: #FFFFFF;"><i class="bi bi-clock-history me-2"></i> Histórico de Consultas</h5>
        <span class="badge" style="background-color: #17A5DE;">@History.Count registros</span>
    </div>
    <div class="card-body p-0 bg-white">
        <div class="table-responsive">
            <table class="table table-hover table-light mb-0 custom-history-table">
                <thead>
                    <tr>
                        <th class="ps-4">Contato</th>
                        <th>ID do Chat</th>
                        <th>Status</th>
                        <th>Espera</th>
                        <th>Pesquisado em</th>
                        <th class="pe-4 text-end">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    @if (History.Count == 0)
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted bg-white">
                                <i class="bi bi-folder-x d-block mb-2" style="font-size: 2rem;"></i>
                                Nenhuma pesquisa realizada ainda.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var record in History)
                        {
                            <tr class="align-middle bg-white">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="avatar-sm">
                                            @if (!string.IsNullOrEmpty(record.ContactProfilePictureUrl))
                                            {
                                                <img src="@record.ContactProfilePictureUrl" alt="@record.ContactName" class="rounded-circle border border-light" style="width: 32px; height: 32px;" />
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center text-dark border" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                    @GetInitials(record.ContactName)
                                                </div>
                                            }
                                        </div>
                                        <div class="fw-bold text-dark">@(record.ContactName ?? "Desconhecido")</div>
                                    </div>
                                </td>
                                <td>
                                    <small class="font-monospace text-muted">@record.ChatId</small>
                                </td>
                                <td>
                                    @if (record.IsOpen)
                                    {
                                        <span class="badge badge-open">Aberto</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-closed">Fechado</span>
                                    }
                                </td>
                                <td>
                                    @if (record.IsWaiting && record.WaitingSinceUTC.HasValue)
                                    {
                                        <span class="text-warning small"><i class="bi bi-hourglass-split"></i> @FormatWaitingTime(record.WaitingSinceUTC.Value)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td class="text-muted small">
                                    @record.SearchedAtUTC.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                </td>
                                <td class="pe-4 text-end">
                                    <button class="btn btn-sm" style="background: linear-gradient(135deg, #005C55 0%, #17A5DE 100%); color: white;" @onclick="() => OnSelect.InvokeAsync(record)">
                                        <i class="bi bi-eye"></i> Visualizar
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .history-card {
        border: none !important;
        border-radius: var(--radius);
        overflow: hidden;
    }
    .custom-history-table {
        border-collapse: separate;
        border-spacing: 0;
        background: white !important;
    }
    .custom-history-table thead th {
        background: #f8f9fa !important;
        border-bottom: 2px solid #dee2e6 !important;
        color: #495057 !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    .custom-history-table tbody tr {
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #dee2e6 !important;
    }
    .custom-history-table tbody tr:hover {
        background-color: #f1f3f5 !important;
    }
    .avatar-sm {
        flex-shrink: 0;
    }
    .badge-open {
        background: rgba(34, 197, 94, 0.2);
        color: #1b5e20 !important;
        border: 1px solid rgba(34, 197, 94, 0.4);
    }
    .badge-closed {
        background: rgba(100, 116, 139, 0.2);
        color: #334155 !important;
        border: 1px solid rgba(100, 116, 139, 0.4);
    }
    .badge-waiting {
        background: rgba(245, 158, 11, 0.2);
        color: #9a3412 !important;
        border: 1px solid rgba(245, 158, 11, 0.4);
    }
    .text-dark { color: #000000 !important; }
</style>

@code {
    [Parameter]
    public List<ChatInfoRecord> History { get; set; } = new();

    [Parameter]
    public EventCallback<ChatInfoRecord> OnSelect { get; set; }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string FormatWaitingTime(DateTime waitingSince)
    {
        var duration = DateTime.UtcNow - waitingSince;
        if (duration.TotalDays >= 1)
            return $"{(int)duration.TotalDays}d";
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h";
        return $"{(int)duration.TotalMinutes}m";
    }
}
